<?phpinclude '../../../include/cp_header.php';if (file_exists('../language/' . $xoopsConfig['language'] . '/admin.php')) {    include '../language/' . $xoopsConfig['language'] . '/admin.php';} else {    include '../language/english/admin.php';}$op = '';foreach ($_POST as $k => $v) {    ${$k} = $v;}if (isset($_GET['op'])) {    $op = $_GET['op'];    if (isset($_GET['id'])) {        $id = (int)$_GET['id'];    }}switch ($op) {    case 'new':        im_admin_new();        break;    case 'edit':        im_admin_edit($id);        break;    case 'update':        im_admin_update($id, $title, $link, $hide, $groups, $target);        break;    case 'del':        im_admin_del($id, $del);        break;    case 'move':        im_admin_move($id, $weight);        im_admin_list();        break;    default:        im_admin_list();        break;}function im_admin_update($id, $title, $link, $hide, $groups, $target){    $xoopsDB = XoopsDatabaseFactory::getDatabaseConnection();    $myts    = MyTextSanitizer::getInstance();    $title   = $myts->addSlashes($title);    $link    = $myts->addSlashes($link);    $groups  = (is_array($groups)) ? implode(' ', $groups) : '';    if (empty($id)) {        $newid   = $xoopsDB->genId($xoopsDB->prefix('imenu') . '_id_seq');        $success = $xoopsDB->query('INSERT INTO ' . $xoopsDB->prefix('imenu') . " (id,title,hide,link,weight,groups,target) VALUES ($newid,'$title','$hide','$link','255','$groups','$target')");        im_admin_clean();    } else {        $success = $xoopsDB->query('UPDATE ' . $xoopsDB->prefix('imenu') . " SET title='$title', hide='$hide', link='$link', groups='$groups', target='$target' WHERE id='$id'");    }    if (!$success) {        redirect_header('index.php', 2, _IM_UPDATED);    } else {        redirect_header('index.php', 2, _IM_UPDATED);    }    exit();}function im_admin_edit($id){    xoops_cp_header();    $xoopsDB = XoopsDatabaseFactory::getDatabaseConnection();    $result  = $xoopsDB->query('SELECT title, hide, link, groups, target FROM ' . $xoopsDB->prefix('imenu') . " WHERE id=$id");    [$title, $hide, $link, $groups, $target] = $xoopsDB->fetchRow($result);    $groups = explode(' ', $groups);    require XOOPS_ROOT_PATH . '/class/xoopsformloader.php';    $form = new XoopsThemeForm(_IM_EDITIMENU, 'editform', 'index.php');    require dirname(__DIR__) . '/imenuform.inc.php';    $form->display();    xoops_cp_footer();}function im_admin_del($id, $del = 0){    $xoopsDB = XoopsDatabaseFactory::getDatabaseConnection();    if ($del == 1) {        if ($xoopsDB->query('DELETE FROM ' . $xoopsDB->prefix('imenu') . " WHERE id=$id")) {            im_admin_clean();            redirect_header('index.php', 2, _IM_UPDATED);        } else {            redirect_header('index.php', 2, _IM_NOTUPDATED);        }        exit();    } else {        xoops_cp_header();        echo '<h4>' . _IM_IMENUADMIN . '</h4>';        xoops_confirm(['op' => 'del', 'id' => $id, 'del' => 1], 'index.php', _IM_SUREDELETE);        xoops_cp_footer();    }}function im_admin_move($id, $weight){    $xoopsDB = XoopsDatabaseFactory::getDatabaseConnection();    $xoopsDB->queryF('UPDATE ' . $xoopsDB->prefix('imenu') . " SET weight=weight+1 WHERE weight>=$weight AND id<>$id");    $xoopsDB->queryF('UPDATE ' . $xoopsDB->prefix('imenu') . " SET weight=$weight WHERE id=$id");    im_admin_clean();}function im_admin_new(){    xoops_cp_header();    $id             = 0;    $title          = '';    $link           = '';    $hide           = '';    $weight         = 255;    $target         = '_self';    $memberHandler = xoops_getHandler('member');    $xoopsgroups    = $memberHandler->getGroups();    $count          = count($xoopsgroups);    $groups         = [];    for ($i = 0; $i < $count; $i++) {        $groups[] = $xoopsgroups[$i]->getVar('groupid');    }    require XOOPS_ROOT_PATH . '/class/xoopsformloader.php';    $form = new XoopsThemeForm(_IM_NEWIMENU, 'newform', 'index.php');    require dirname(__DIR__) . '/imenuform.inc.php';    $form->display();    xoops_cp_footer();}function im_admin_list(){    xoops_cp_header();    $xoopsDB = XoopsDatabaseFactory::getDatabaseConnection();    echo '<h4>' . _IM_IMENUADMIN . "</h4>	<form action='index.php?op=new' method='post' name='form1'>	<table width='100%' border='0' cellspacing='1' cellpadding='0' class='outer'><tr>	<th align='center'>" . _IM_TITLE . "</th>	<th align='center'>" . _IM_HIDE . "</th>	<th align='center'>" . _IM_LINK . "</th>	<th align='center'>" . _IM_OPERATION . '</th></tr>';    $result = $xoopsDB->query('SELECT id, link, title, hide, weight FROM ' . $xoopsDB->prefix('imenu') . ' ORDER BY weight ASC');    $class  = 'even';    while (false !== ($row = $xoopsDB->fetchArray($result)) {        $status = ($row['hide'] == 0) ? _NO : _YES;        if ($row['weight'] != 0) {            $moveup = "<a href='index.php?op=move&id=" . $row['id'] . '&weight=' . ($row['weight'] - 1) . "'>[" . _IM_UP . ']</a>';        } else {            $moveup = '[' . _IM_UP . ']';        }        if ($row['weight'] != ($xoopsDB->getRowsNum($result) - 1)) {            $movedown = "<a href='index.php?op=move&id=" . $row['id'] . '&weight=' . ($row['weight'] + 2) . "'>[" . _IM_DOWN . ']</a>';        } else {            $movedown = '[' . _IM_DOWN . ']';        }        echo "<tr>			<td class='$class'>" . $row['title'] . "</td>			<td class='$class' align='center'>$status</td>			<td class='$class'>" . $row['link'] . "</td>			<td class='$class' align='center'><small><a href='index.php?op=del&id=" . $row['id'] . "'>[" . _DELETE . "]</a>			<a href='index.php?op=edit&id=" . $row['id'] . "'>[" . _EDIT . ']</a>' . $moveup . $movedown . '</small></td></tr>';        $class = ($class == 'odd') ? 'even' : 'odd';    }    echo "<tr><td class='foot' colspan='4' align='right'>	<input type='submit' name='submit' value='" . _IM_NEW . "'>	</td></tr></table></form>";    xoops_cp_footer();}function im_admin_clean(){    global $xoopsDB;    $i      = 0;    $result = $xoopsDB->query('SELECT id FROM ' . $xoopsDB->prefix('imenu') . ' ORDER BY weight ASC');    while (list($id) = $xoopsDB->fetchRow($result))) {        $xoopsDB->queryF('UPDATE ' . $xoopsDB->prefix('imenu') . " SET weight='$i' WHERE id=$id");        $i++;    }}